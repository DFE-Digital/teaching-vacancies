ruby:
  form = Jobseekers::JobPreferencesForm.from_record(current_jobseeker.job_preferences)
  attributes = {
    roles: {
      map_values: ->(value, step) { step.options[value] },
      join_with: '</br></br>'
    },
    phases: {
      map_values: ->(value, step) { step.options[value] },
      join_with: ', '
    },
    key_stages: {
      map_values: ->(value, step) { step.options[value] },
      join_with: ', '
    },
    working_patterns: {
      map_values: ->(value, step) { step.options[value] },
      join_with: ', '
    },
    locations: {
      if: ->(form) { form.locations.any? || form.completed?(:locations) },
      map_values: ->(value, _) { "#{value[:location]} (#{I18n.t("jobs.search.number_of_miles", count: value[:radius])})" },
      join_with: '</br>'
    }
  }

  summary_list = govuk_summary_list do |summary_list|
    attributes.each do |attribute, options|
      step_name = form.class.delegated_attributes[attribute.to_s]
      condition = options[:if] || -> (form) { form.completed?(step_name) }
      next unless condition.(form)

      value = form.public_send(attribute)
      if options[:map_values]
        value = value.map { |elem| options[:map_values].(elem, form.steps[step_name]) }
        value = value.map { |elem| ''.html_safe + elem }
        value = value.join(options[:join_with].html_safe).html_safe
      end

      summary_list.row do |row|
        row.key text: t(attribute)
        row.value text: value
        row.action(text: t("buttons.change"), href: jobseekers_job_preferences_step_path(step: step_name))
      end
    end
  end

- if form.completed?
  = summary_list
- else
  .govuk-inset-text.govuk-inset-text--incomplete
    = summary_list
    p.govuk-body-m.govuk-inset-text--header
      strong You must complete your job preferences before you turn on your profile.
    = govuk_link_to 'Complete job preferences', jobseekers_job_preferences_step_path(step: form.next_step), class: 'govuk-button'

    / - summary_list.row do |row|
    /   - step_name = form.class.delegated_attributes['roles']
    /   - row.key text: "Roles"
    /   - row.value text: form.roles.map { |role| form.steps[step_name].options[role] }.join('</br></br>').html_safe
    /   - row.action(text: t("buttons.change"), href: jobseekers_job_preferences_step_path(step: step_name))

    / - summary_list.row do |row|
    /   - step_name = form.class.delegated_attributes['phases']
    /   - row.key text: "Phases"
    /   - row.value text: form.phases.map { |phase| form.steps[step_name].options[phase] }.join(', ')
    /   - row.action(text: t("buttons.change"), href: jobseekers_job_preferences_step_path(step: step_name))
    /
    / - summary_list.row do |row|
    /   - step_name = form.class.delegated_attributes['key_stages']
    /   - row.key text: "Key stages"
    /   - row.value text: form.key_stages.map { |stage| form.steps[step_name].options[stage] }.join(', ')
    /   - row.action(text: t("buttons.change"), href: jobseekers_job_preferences_step_path(step: step_name))
    /
    / - summary_list.row do |row|
    /   - step_name = form.class.delegated_attributes['working_patterns']
    /   - row.key text: "Working patterns"
    /   - row.value text: form.working_patterns.map { |pattern| form.steps[step_name].options[pattern] }.join(', ')
    /   - row.action(text: t("buttons.change"), href: jobseekers_job_preferences_step_path(step: step_name))
    /
    / - summary_list.row do |row|
    /   - step_name = form.class.delegated_attributes['working_patterns']
    /   - row.key text: "Working patterns"
    /   - row.value text: form.working_patterns.map { |pattern| form.steps[step_name].options[pattern] }.join(', ')
    /   - row.action(text: t("buttons.change"), href: jobseekers_job_preferences_step_path(step: step_name))
    /
    /
    / - summary_list.row do |row|
    /   - step_name = form.class.delegated_attributes['locations']
    /   - row.key text: "Locations"
    /   - row.value text: form.locations.map { |location| "#{location[:location]} (#{location[:radius]})" }.join('</br>'.html_safe)
    /   - row.action(text: t("buttons.change"), href: jobseekers_job_preferences_step_path(step: step_name))
