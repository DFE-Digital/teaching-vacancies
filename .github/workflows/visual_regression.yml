name: Visual Regression

on:
  workflow_dispatch:
    inputs:
      sha:
        description: GitHub SHA
        required: true
      visual_regression_test_domain:
        description: Domain to smoke test
        required: true
        default: teaching-vacancies.service.gov.uk

jobs:
  visual-regression-test:
    name: Visual Regression ${{ github.event.inputs.visual_regression_test_domain }} ${{ github.event.inputs.sha }}

    runs-on: ubuntu-20.04

    env:
      RAILS_ENV: test
      VISUAL_REGRESSION_TEST_DOMAIN: ${{ github.event.inputs.visual_regression_test_domain }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node
        uses: actions/setup-node@v2.1.5
        with:
          node-version: '12.x'

      - name: Install yarn
        run: npm install yarn -g

      - name: Yarn cache
        id: yarn-cache
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - name: Set up yarn cache
        uses: actions/cache@v2.1.4
        with:
          path: ${{ steps.yarn-cache.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install node.js dependencies
        run: yarn install

      - name: run visual regression tests
        run: docker run --rm --mount type=bind,source="/home/runner/work/teaching-vacancies/teaching-vacancies",target=/src backstopjs/backstopjs:5.3.0 test "--moby" "--config=config/backstop/backstop.config.js"
