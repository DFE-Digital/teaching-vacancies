name: Build and deploy

on:
  push:
    branches:
    - main
    - dev     # Push to branch other than main deploys directly to environment with the same name. ie 'dev' branch deploys to 'dev' environment
    paths-ignore:
    - 'bigquery/**'
    - 'documentation/**'
    - 'terraform/common/**'
    - '**.md'

  pull_request:
    branches:
    - main
    types:
      - labeled
      - opened
      - synchronize
      - reopened

env:
 DOCKER_REPOSITORY: ghcr.io/dfe-digital/teaching-vacancies

jobs:

  build:
    if: contains(github.event.pull_request.labels.*.name, 'deploy') || github.event_name != 'pull_request'
    name: Build docker image
    outputs:
      build_git_tag: ${{steps.tag_version.outputs.new_tag}}
      matrix_environments: ${{ env.MATRIX_ENVIRONMENTS }}
      docker_image_tag: ${{ env.DOCKER_IMAGE_TAG }}
      commit_sha: ${{ env.COMMIT_SHA }}
      scan_docker_image: ${{ env.DOCKER_REPOSITORY }}:${{ env.DOCKER_IMAGE_TAG }}
      LINK_TO_RUN: ${{ env.LINK_TO_RUN }}
    runs-on: ubuntu-20.04

    steps:
      - name: Check workflow concurrency
        uses: DFE-Digital/github-actions/turnstyle@master
        with:
          initial-wait-seconds: 12
          poll-interval-seconds: 20
          abort-after-seconds: 1800
          same-branch-only: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v2
        name: Checkout Code

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2
          role-to-assume: Deployments
          role-duration-seconds: 3600
          role-skip-session-tagging: true

      - name: Get SLACK_WEBHOOK From ParameterStore
        uses: "marvinpinto/action-inject-ssm-secrets@latest"
        with:
          ssm_parameter: "/teaching-vacancies/github_action/infra/slack_webhook"
          env_variable_name: SLACK_WEBHOOK

      - name: Set environment variables (Push)
        if: github.event_name == 'push'
        run: |
          GIT_REF=${{ github.ref }}
          echo "GIT_BRANCH=${GIT_REF##*/}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${GITHUB_SHA}" >> $GITHUB_ENV

      - name: Set environment variables (Pull request)
        if: github.event_name == 'pull_request'
        run: |
          # This is the actual PR branch
          GIT_REF=${{ github.head_ref }}
          echo "GIT_BRANCH=${GIT_REF##*/}" >> $GITHUB_ENV
          # This is the latest commit on the actual PR branch
          echo "COMMIT_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV

      - name: Set common environment variables
        run: |
          echo "DOCKER_IMAGE_TAG=${GIT_BRANCH}-${COMMIT_SHA}" >> $GITHUB_ENV
          echo "LINK_TO_RUN=https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
            registry: ghcr.io
            username: ${{ github.repository_owner }}
            password: ${{ secrets.GIT_HUB_SERVICE_ACCOUNT_TOKEN }}

      - name: Build and push docker image from builder target
        uses: docker/build-push-action@v2
        with:
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          # Cache from builder target tagged with branch name, may be empty first time branch is pushed
          # Cache from builder target tagged with main branch name, always present, maybe less recent
          cache-from: |
            ${{ env.DOCKER_REPOSITORY }}:builder-${{ env.GIT_BRANCH }}
            ${{ env.DOCKER_REPOSITORY }}:builder-main
          push: true
          # Tag with branch name for reuse
          tags: ${{ env.DOCKER_REPOSITORY }}:builder-${{ env.GIT_BRANCH }}
          target: builder

      - name: Build and push docker image from production target
        uses: docker/build-push-action@v2
        with:
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            COMMIT_SHA=${{ env.COMMIT_SHA }}
          # Cache from builder target built above, always present
          # Cache from production target tagged with branch name, may be empty first time branch is pushed
          # Cache from production target tagged with main branch name, always present, maybe less recent
          cache-from: |
            ${{ env.DOCKER_REPOSITORY }}:builder-${{ env.GIT_BRANCH }}
            ${{ env.DOCKER_REPOSITORY }}:${{ env.GIT_BRANCH }}
            ${{ env.DOCKER_REPOSITORY }}:main
          push: false
          load: true
          # Tag with branch name for reuse
          # Tag with branch name and commit sha for unique identification
          tags: |
            ${{ env.DOCKER_REPOSITORY }}:${{ env.GIT_BRANCH }}
            ${{ env.DOCKER_REPOSITORY }}:${{ env.DOCKER_IMAGE_TAG }}
          target: production

      # Creates a unique git tag to help synchronising dependent jobs
      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set matrix environments (Push to main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: echo "MATRIX_ENVIRONMENTS={\"environment\":[\"staging\",\"production\",\"qa\", \"research\"]}" >> $GITHUB_ENV

      - name: Set matrix environments (Push to non main branch)
        if: github.event_name == 'push' && github.ref != 'refs/heads/main'
        run: echo "MATRIX_ENVIRONMENTS={\"environment\":[\"${GIT_BRANCH}\"]}" >> $GITHUB_ENV

      - name: Set matrix environments (Pull request)
        if: github.event_name == 'pull_request'
        run: echo "MATRIX_ENVIRONMENTS={\"environment\":[\"review\"]}" >> $GITHUB_ENV

      - name: Scan ${{ env.DOCKER_REPOSITORY }}:${{ env.DOCKER_IMAGE_TAG }} image
        id: scan_docker_image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker run -t -e "SNYK_TOKEN=${{ secrets.SNYK_TOKEN }}" \
            -v "/var/run/docker.sock:/var/run/docker.sock" \
            -v "$GITHUB_WORKSPACE:/project"  \
            snyk/snyk-cli:docker test --docker ${{ env.DOCKER_REPOSITORY }}:${{ env.DOCKER_IMAGE_TAG }} --file=Dockerfile

      - name: Push ${{ env.DOCKER_REPOSITORY }} images
        if: ${{ success() }}
        run: |
          docker image push --all-tags ${{ env.DOCKER_REPOSITORY }}
          exit 1

      - name: Notify twd_tv_dev channel on build workflow failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2.2.0
        env:
          SLACK_CHANNEL: twd_tv_dev
          SLACK_USERNAME: CI Deployment
          SLACK_TITLE: Build failure
          SLACK_MESSAGE: |
            Build failure on branch ${{env.GIT_BRANCH}} <!channel>
            See: <${{ env.LINK_TO_RUN }}|Workflow run>
          SLACK_WEBHOOK: $SLACK_WEBHOOK
          SLACK_COLOR: failure

  deploy:
    name: Deploy app
    strategy:
      max-parallel: 1
      # Creates a variable 'environment' from the build job output 'matrix_environments'
      # Its value is the list of environments. The matrix iterates once per environment and the value is accessed via ${{ matrix.environment }}
      matrix: ${{fromJSON(needs.build.outputs.matrix_environments)}}
    needs: [build]
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v2
      name: Checkout Code

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-2
        role-to-assume: Deployments
        role-duration-seconds: 3600
        role-skip-session-tagging: true

    - name: Get SLACK_WEBHOOK From ParameterStore
      uses: "marvinpinto/action-inject-ssm-secrets@latest"
      with:
        ssm_parameter: "/teaching-vacancies/github_action/infra/slack_webhook"
        env_variable_name: SLACK_WEBHOOK

    - name: Set environment variables from build output
      run: |
        echo "COMMIT_SHA=${{ needs.build.outputs.commit_sha }}" >> $GITHUB_ENV
        echo "DOCKER_IMAGE_TAG=${{ needs.build.outputs.docker_image_tag }}" >> $GITHUB_ENV
        echo "BUILD_GIT_TAG=${{ needs.build.outputs.build_git_tag}}" >> $GITHUB_ENV
        echo "LINK_TO_RUN=${{ needs.build.outputs.LINK_TO_RUN}}" >> $GITHUB_ENV

    - name: Set environment variable (Push)
      if: github.event_name == 'push'
      run: |
        ENVIRONMENT=${{ matrix.environment }}
        echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_ENV

    - name: Set environment variable (Pull request)
      if: github.event_name == 'pull_request'
      run: |
        ENVIRONMENT=review-pr-${{ github.event.number }}
        echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_ENV

    - name: Trigger Deploy App Workflow for ${{ env.ENVIRONMENT }}
      uses: benc-uk/workflow-dispatch@v1.1
      with:
        workflow: Deploy App to Environment   # Name of the triggered workflow
        token: ${{ secrets.GIT_HUB_SERVICE_ACCOUNT_TOKEN }}
        ref: ${{ env.BUILD_GIT_TAG }}         # Different than branch HEAD SHA in case of a PR
        inputs: '{"environment": "${{ env.ENVIRONMENT }}", "tag": "${{ env.DOCKER_IMAGE_TAG }}", "pr_id": "${{ github.event.number }}" }'

    - name: Wait for Deploy App Workflow for ${{ env.ENVIRONMENT }}
      id: wait_for_deploy_app
      uses: fountainhead/action-wait-for-check@v1.0.0
      with:
        token: ${{ secrets.GIT_HUB_SERVICE_ACCOUNT_TOKEN }}
        checkName: Deploy ${{ env.DOCKER_IMAGE_TAG }} to ${{ env.ENVIRONMENT }} # Job name within triggered workflow
        ref: ${{ env.BUILD_GIT_TAG }}
        timeoutSeconds: 1200
        intervalSeconds: 14

    - name: Notify twd_tv_dev channel on ${{ env.ENVIRONMENT }} deployment failure
      if: steps.wait_for_deploy_app.outputs.conclusion != 'success'
      uses: rtCamp/action-slack-notify@v2.2.0
      env:
        SLACK_CHANNEL: twd_tv_dev
        SLACK_USERNAME: CI Deployment
        SLACK_TITLE: Deployment failure
        SLACK_MESSAGE: 'Deployment of Docker image ${{ env.DOCKER_IMAGE_TAG }} to ${{ env.ENVIRONMENT }} - unsuccessful <!channel>'
        SLACK_WEBHOOK: ${SLACK_WEBHOOK}

    - name: Exit whole workflow if ${{ env.ENVIRONMENT }} deployment was not successful
      if: steps.wait_for_deploy_app.outputs.conclusion != 'success'
      run: exit 1

    - name: Trigger Smoke Test
      uses: benc-uk/workflow-dispatch@v1.1
      with:
        workflow: Smoke Test
        token: ${{ secrets.GIT_HUB_SERVICE_ACCOUNT_TOKEN }}
        inputs: '{"paas_environment": "${{ env.ENVIRONMENT }}", "sha": "${{ env.COMMIT_SHA }}"}'
        ref: ${{ env.BUILD_GIT_TAG }}

    - name: Wait for smoke test
      id: wait_for_smoke_test
      uses: fountainhead/action-wait-for-check@v1.0.0
      with:
        token: ${{ secrets.GIT_HUB_SERVICE_ACCOUNT_TOKEN }}
        checkName: Smoke Test ${{ env.ENVIRONMENT }} ${{ env.COMMIT_SHA }}
        ref: ${{ env.BUILD_GIT_TAG }}
        timeoutSeconds: 300
        intervalSeconds: 15

    - name: Exit whole workflow if ${{ env.ENVIRONMENT }} smoke test was not successful
      if: steps.wait_for_smoke_test.outputs.conclusion != 'success'
      run: exit 1

    - name: Post sticky pull request comment
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        message: |
          Review app deployed to <https://teaching-vacancies-${{ env.ENVIRONMENT }}.london.cloudapps.digital>

    - name: Send job status message to twd_tv_dev channel
      if: failure()
      uses: rtCamp/action-slack-notify@v2.2.0
      env:
        SLACK_CHANNEL: twd_tv_dev
        SLACK_USERNAME: CI Deployment
        SLACK_TITLE: Deployment ${{ job.status }}
        SLACK_MESSAGE: |
          Deployment of Docker image ${{ env.DOCKER_IMAGE_TAG }} to ${{matrix.environment}} - ${{ job.status }}
          See: <${{ env.LINK_TO_RUN }}|Workflow run>
        SLACK_WEBHOOK: ${SLACK_WEBHOOK}
        SLACK_COLOR: failure

  post_deployment:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: Post deployment steps
    needs: [build, deploy]
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2
        name: Checkout Code

      - name: Set environment variables from build output
        run: |
          echo "DOCKER_IMAGE_TAG=${{ needs.build.outputs.docker_image_tag }}" >> $GITHUB_ENV
          echo "LINK_TO_RUN=${{ needs.build.outputs.LINK_TO_RUN}}" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2
          role-to-assume: Deployments
          role-duration-seconds: 3600
          role-skip-session-tagging: true

      - name: Get SLACK_WEBHOOK From ParameterStore
        uses: "marvinpinto/action-inject-ssm-secrets@latest"
        with:
          ssm_parameter: "/teaching-vacancies/github_action/infra/slack_webhook"
          env_variable_name: SLACK_WEBHOOK

      - name: Terraform pin version
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.0.8

      - name: Deploy monitoring
        run: |
          terraform init -upgrade=true -reconfigure -input=false
          terraform apply -input=false -auto-approve
        working-directory: terraform/monitoring

      - name: Download and extract Gov.UK frontend archive
        run: bin/regenerate-offline

      - name: Sync offline S3 bucket
        run: bin/sync-offline

      - name: Send job status message to twd_tv_dev channel
        if: always()
        uses: rtCamp/action-slack-notify@v2.2.0
        env:
          SLACK_CHANNEL: twd_tv_dev
          SLACK_USERNAME: CI Deployment
          SLACK_TITLE: Deployment ${{ job.status }}
          SLACK_MESSAGE: |
            Deployment of Docker tag ${{ env.DOCKER_IMAGE_TAG }} - ${{ job.status }}
            See: <${{ env.LINK_TO_RUN }}|Workflow run>
          SLACK_WEBHOOK: ${SLACK_WEBHOOK}
          SLACK_COLOR: ${{ job.status }}
