#!/bin/bash
set -eu
CF_ORG='dfe'

if [ $CF_ORIGIN == $CF_TARGET ]
then
  echo "CF_ORIGIN should not equal CF_TARGET. They are both set to $CF_TARGET"
  exit 1
fi

if [ $CF_TARGET == "production" ]
then
  echo "CF_TARGET should not equal production"
  exit 1
fi

cf7 api $CF_API_ENDPOINT
cf7 auth

cf7 target -o $CF_ORG -s $CF_SERVICE_NAME-$CF_ORIGIN
cf7 conduit "$CF_SERVICE_NAME-postgres-$CF_ORIGIN" --app-name $CF_SERVICE_NAME-conduit-$CF_ORIGIN -- pg_dump -x --no-owner -c -f backup.sql
# The conduit app may have to be deleted explicitly
cf7 delete -f $CF_SERVICE_NAME-conduit-$CF_ORIGIN || true

cf7 target -o $CF_ORG -s $CF_SERVICE_NAME-$CF_TARGET
cf7 conduit "$CF_SERVICE_NAME-postgres-$CF_TARGET" --app-name $CF_SERVICE_NAME-conduit-$CF_TARGET -- psql < backup.sql
# The conduit app may have to be deleted explicitly
cf7 delete -f $CF_SERVICE_NAME-conduit-$CF_TARGET || true
