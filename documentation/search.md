# Search

We use [Algolia's](https://algolia.com) search-as-a-service offering to provide an advanced search experience for our jobseekers.

To log in to the Algolia dashboard, you will need access to the teachingjobs@digital.education.gov.uk shared user, as the team size is limited by our payment tier.

We have three applications in Algolia, this is the setup:

- Local development, review apps, Dev(GOV.UK PaaS) -> Dev Algolia App
- Staging(GOV.UK PaaS) -> Staging Algolia App
- Production(GOV.UK PaaS) -> Production Algolia App

## Environment Variables

If you managed to [fetch the dev variables and output to a shell environment file](https://github.com/DFE-Digital/teaching-vacancies#environment-variables)

```
aws-vault exec ReadOnly -- make -s local print-env > .env
```

The following environment variables should be set in your `.env` file:

```bash
ALGOLIA_APP_ID=
ALGOLIA_INDEX_PREFIX=
ALGOLIA_SEARCH_API_KEY=
ALGOLIA_WRITE_API_KEY=
```

The Algolia index prefix will be generated by default with your Unix username (`whoami`). If it's not convenient, edit it manually in `.env`.

The index prefix is used so that a single Algolia app called `Dev` can be shared among all the developers and the review apps, by prefixing the index names.

## Quickstart

To load an index with live records for the first time:

```bash
bundle exec rails algolia:reindex
```

To update a live index with newly published records using minimal operations:

```bash
bundle exec rails algolia:update_index
```

To remove the indices in Algolia:

```bash
bundle exec rails algolia:remove_indices
```

Existing records will be updated so long as they continue to meet the `listed` conditions.

## Timed jobs

There are two timed jobs that run in sidekiq cron:

### `UpdateAlgoliaIndex`

This runs every five minutes and add vacancies with matured `publish_on` times to the index.

### `RemoveVacanciesThatExpiredYesterdayFromAlgolia`

This runs at 03:00 every day and does exactly what the name says it does. Daily removal is not a problem because expired vacancies that have not yet been removed will be filtered out by the search client and do not show to jobseekers.

## Indexing live records

We originally started by indexing all records. It became apparent that this had unnecessary cost implications, so the
codebase was refactored to index only live (or `listed`) records. The [Algolia](https://algoliac.om) Rails plugin is
now set so it automatically updates existing live records if they change.

NOTE: The default `#reindex!` method, added by the Algolia gem, has been overridden so it only indexes Vacancies records
that fall under the scope `#live`. This is to ensure that expired and unpublished records do not get accidentally added.

## Algolia index settings

Algolia can be configured with the Web UI. When settings change, a developer needs to be notified so that a new export can be extracted into the file:

[config/algolia_settings.json](/config/algolia_settings.json)
